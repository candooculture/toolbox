<!DOCTYPE html>

<html lang="en">
<head><meta charset="utf-8"/>
<title>Customer Churn</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600&amp;display=swap" rel="stylesheet"/>
<link href="clarity-style.css" rel="stylesheet"/></head>
<body>
<h1>Customer Churn</h1>
<div class="info-banner">
<strong>Weâ€™ve pre-filled your industry averages to save you time.</strong><br/>
    These reflect common performance in your sector.<br/>
<em>Have your own data?</em> Just update the fields to sharpen your results.
  </div>
<form id="churn-form">
<label>Industry:</label>
<select id="industry" name="industry" required="">
<option value="">Select your industry</option>
<option value="Agriculture / Farming">Agriculture / Farming</option>
<option value="Construction">Construction</option>
<option value="Education &amp; Training">Education &amp; Training</option>
<option value="Finance &amp; Insurance">Finance &amp; Insurance</option>
<option value="Government / Public Sector">Government / Public Sector</option>
<option value="Healthcare">Healthcare</option>
<option value="Hospitality">Hospitality</option>
<option value="Integrated Services">Integrated Services</option>
<option value="Logistics &amp; Transport">Logistics &amp; Transport</option>
<option value="Manufacturing">Manufacturing</option>
<option value="Media / Creative / Comms">Media / Creative / Comms</option>
<option value="Non-Profit">Non-Profit</option>
<option value="Professional Services">Professional Services</option>
<option value="Real Estate &amp; Property">Real Estate &amp; Property</option>
<option value="Retail">Retail</option>
<option value="Technology / SaaS">Technology / SaaS</option>
<option value="Utilities / Energy / Waste">Utilities / Energy / Waste</option>
</select>
<label>Number of Active Customers:</label>
<input id="num_customers" name="num_customers" required="" type="number"/>
<label>Average Revenue per Customer (AUD $/year):</label>
<input id="avg_revenue" name="avg_revenue" required="" step="0.01" type="number"/>
<label>Customer Acquisition Cost (CAC):</label>
<input id="cac" name="cac" required="" step="0.01" type="number"/>
<span class="benchmark-label" id="label-cac">(Using industry average)</span>
<small>Include average marketing, onboarding, and sales cost per new customer</small>
<label>Current Customer Churn Rate (% per year):</label>
<input id="churn_rate" name="churn_rate" required="" step="0.1" type="number"/>
<span class="benchmark-label" id="label-churn">(Using industry average)</span>
<small>e.g., 7 = 7% of customers leave annually</small>
<label>Desired Churn Improvement (% reduction target):</label>
<input id="desired_improvement" name="desired_improvement" required="" step="0.1" type="number"/>
<small>e.g., 5 = reduce churn from 10% to 5%</small>
<button type="submit">Calculate</button>
</form>
<p class="benchmark-note">
    The following results reflect potential performance insights, based on typical industry benchmarks and Candooâ€™s proprietary logic.
  </p>
<pre id="churn-result"></pre>
<div class="cta" id="cta-bottom">
<h3>ðŸŽ¯ If churn feels invisible, itâ€™s because it is. Letâ€™s surface it.</h3>
<button onclick="window.location.href='tel:+61YOURNUMBER'">ðŸ“ž Book a Strategy Call</button>
<button onclick="window.location.href='mailto:admin@candooculture.com?subject=Help Me Understand What to Do Next'">
      ðŸ“§ Prefer Email? Letâ€™s Help You Understand What to Do Next
    </button>
</div>
<script>
(() => {
  const MODULE   = "customer-churn";
  const API_BASE = "https://candoo-clarity.onrender.com";

  const form           = document.getElementById("churn-form");
  const industrySelect = document.getElementById("industry");
  const churnInput     = document.getElementById("churn_rate");
  const cacInput       = document.getElementById("cac");
  const labelChurn     = document.getElementById("label-churn");
  const labelCAC       = document.getElementById("label-cac");
  const resultBox      = document.getElementById("churn-result");
  const cta            = document.getElementById("cta-bottom");

  function markPrefilled(input, label, value) {
    if (input.value.trim() === "") {
      input.value = value;
      input.classList.add("prefilled");
      label.style.display = "inline";
    }
  }
  function clearOnEdit(input, label) {
    input.addEventListener("input", () => {
      input.classList.remove("prefilled");
      label.style.display = "none";
    });
  }
  clearOnEdit(churnInput, labelChurn);
  clearOnEdit(cacInput, labelCAC);

  async function fetchBenchmarks(industry) {
    if (!industry) return;
    try {
      const res = await fetch(`${API_BASE}/get-industry-benchmarks?industry=${encodeURIComponent(industry)}`);
      const data = await res.json();
      if (data.churn_rate != null) markPrefilled(churnInput, labelChurn, data.churn_rate);
      if (data.cac        != null) markPrefilled(cacInput,   labelCAC,   data.cac);
    } catch (err) {
      console.error(`[${MODULE}] benchmark fetch failed`, err);
    }
  }

  industrySelect.addEventListener("change", (e) => {
    const selected = e.target.value;
    localStorage.setItem("industry", selected);
    fetchBenchmarks(selected);
  });

  const savedIndustry = localStorage.getItem("industry");
  if (savedIndustry) {
    industrySelect.value = savedIndustry;
    fetchBenchmarks(savedIndustry);
  }

  function byId(id){ return document.getElementById(id); }
  function coalesceNum(...vals){
    for (const v of vals){
      const n = Number(v);
      if (!Number.isNaN(n) && Number.isFinite(n)) return n;
    }
    return 0;
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    resultBox.style.display = "none";
    cta.style.display = "none";

    // Gather + coerce numeric fields
    const data = Object.fromEntries(new FormData(form).entries());
    Object.keys(data).forEach(k => { if (!isNaN(data[k])) data[k] = Number(data[k]); });
    data.last_updated = Date.now();

    // Persist inputs for ORS and cross-module reads
    localStorage.setItem(`${MODULE}-inputs`, JSON.stringify(data));
    window.dispatchEvent(new Event("storage"));
    window.dispatchEvent(new CustomEvent("module-status-updated"));

    try {
      const response = await fetch(`${API_BASE}/run-churn-calculator`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      const result = await response.json();

      if (result && result.revenue_loss != null && result.replacement_cost != null) {
        const totalLoss = (result.revenue_loss || 0) + (result.replacement_cost || 0);

        // New backend fields with safe fallbacks
        const recoveredRevenue = coalesceNum(result.recovered_revenue_abs, result.potential_gain, 0);
        const cacAvoided       = coalesceNum(result.cac_avoided, 0);
        const totalImpact      = coalesceNum(result.total_gain_abs, result.total_gain, recoveredRevenue + cacAvoided);
        const recoveryPctTot   = coalesceNum(result.recovery_percent_total_abs, result.recovery_percent_total, result.recovery_percent, 0);

        // Robust industry label fallback
        const uiIndustry =
          (document.querySelector('#industry')?.selectedOptions?.[0]?.textContent || '').trim()
          || data.industry
          || localStorage.getItem('industry')
          || 'Industry average';

        let output = `ðŸ’¸ Total Annual Loss from Customer Churn: AUD $${totalLoss.toLocaleString()}\n`;
        output += `â€ƒâ€¢ Lost Revenue from Churned Customers: AUD $${(result.revenue_loss||0).toLocaleString()}\n`;
        output += `â€ƒâ€¢ Replacement Cost (CAC): AUD $${(result.replacement_cost||0).toLocaleString()}\n\n`;

        output += `âœ… Based on Your Inputs\n`;
        output += `ðŸŽ¯ Projected Annual Recovery (Revenue Only): AUD $${recoveredRevenue.toLocaleString()}\n`;
        output += `â€ƒâ€¢ CAC Avoided: AUD $${cacAvoided.toLocaleString()}\n`;
        output += `â€ƒâ€¢ Total Annual Impact (Revenue + CAC): AUD $${totalImpact.toLocaleString()}\n\n`;

        output += `ðŸ“ˆ Opportunity\n`;
        output += `ðŸ’° Estimated Recovery (incl. CAC) = ${Number(recoveryPctTot).toFixed(1)}% of Total Churn Loss\n\n`;

        output += `ðŸ“Š Benchmark Check â€” ${uiIndustry} Industry\n`;
        if (result.benchmark_message) output += `- ${result.benchmark_message}\n\n`;

        output += `ðŸ§  Straight Talk\n`;
        output += `You're leaking AUD $${totalLoss.toLocaleString()} every year through churned customers and acquisition costs.\n`;
        output += `Even a small improvement delivers AUD $${totalImpact.toLocaleString()} straight to your bottom line.`;

        resultBox.innerText = output;
        resultBox.style.display = "block";
        cta.style.display = "block";
      } else {
        resultBox.innerText = "Something went wrong.";
        resultBox.style.display = "block";
      }
    } catch (err) {
      console.error(`[${MODULE}] API error`, err);
      resultBox.innerText = "API error. Try again.";
      resultBox.style.display = "block";
    }
  });
})();
</script>
</body>
</html>
