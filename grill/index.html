<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Candoo Clarity Toolbox</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="clarity-style.css">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>

<body>
  <div class="logo">
    <a href="https://candooculture.com/">
      <img src="candoologo.png" alt="Candoo Logo">
    </a>
  </div>

  <h1>Candoo Clarity Toolbox</h1>

  <div class="intro">
    <h2>Behind the Numbers: Your Hidden Costs, Revealed</h2>
    <p>This toolbox was built for one reason - Clarity.</p>
    <p>In every business, inefficiencies, churn, and leadership gaps are silently bleeding time, money, and momentum.</p>
    <p>We built this suite to surface invisible losses and offer a clear, actionable starting point.</p>
    <p>It‚Äôs not a crystal ball, and it‚Äôs not pretending to be tailored to every company‚Äôs nuance. But it‚Äôs close -
      industry benchmarks, smart assumptions, and proven ROI logic are built in to make the invisible‚Ä¶ visible.</p>
    <p>Use it to test scenarios. To validate instincts. To sense-check strategy. Whether you‚Äôre an owner, an operator,
      or a leader who‚Äôs had enough of vague problems and fluffy guesses - this is your starting line.</p>
  </div>

  <div class="ors-warning">
    <h3>üìò Before You Begin</h3>
    <ul>
      <li>‚úÖ Complete all <strong>5 diagnostic modules</strong> before generating your <strong>full</strong> Operational Risk Report. üì©</li>
      <li>‚ö†Ô∏è Your answers may <strong>not be saved permanently</strong>. If you leave a module before finishing, your data may be lost.</li>
      <li>üîÑ Need to start over? Use the <strong>"Reset All Results"</strong> button to clear your data, reset the system and begin again.</li>
    </ul>
  </div>
  
  <div class="reset-wrapper">
    <button id="resetAllBtn" class="reset-button">
      üö® Reset All Results üö®
    </button>
  </div>

  <div class="module-wrapper">
    <div class="tabs" id="tabs"></div>
    <div class="content" id="contentContainer">Loading...</div>
  </div>

  <script>
  const calculators = {
    team_efficiency: { name: "üí∏ Payroll Waste", file: "payroll-waste.html" },
    customer_churn: { name: "üìâ Customer Churn", file: "customer-churn.html" },
    leadership_drag: { name: "üß† Leadership Drag", file: "leadership-drag.html" },
    workforce_productivity: { name: "üìà Workforce Productivity", file: "workforce-productivity.html" },
    productivity_dive: { name: "üîç Productivity Deep Dive", file: "productivity-dive.html" },
    operational_risk: { name: "üî• Operational Risk", file: "operational-risk.html" },
    __admin__: { name: "‚öôÔ∏è Admin", file: "admin.html", protected: true }
  };

  const gatedModules = ["customer_churn", "workforce_productivity", "productivity_dive"];
  let originalSwitchTab;

  async function loadVisibility() {
    const tabsDiv = document.getElementById('tabs');
    const container = document.getElementById('contentContainer');
    tabsDiv.innerHTML = '';

    let visibleKeys = [];

    try {
      const res = await fetch('https://candoo-clarity.onrender.com/admin/get-visibility');
      const data = await res.json();
      if (data.status === 'success' && Array.isArray(data.data)) {
        visibleKeys = data.data
          .filter(item => item.visible)
          .map(item => item.calculator);
      }
    } catch (err) {
      console.warn("‚ö†Ô∏è Could not load visibility settings from backend. Defaulting to all.");
      visibleKeys = Object.keys(calculators).filter(k => !calculators[k].protected);
    }

    Object.keys(calculators).forEach((key) => {
      if (!visibleKeys.includes(key) && key !== '__admin__') return;

      const { name } = calculators[key];
      const tab = document.createElement('div');
      tab.className = 'tab';

      const emailStored = localStorage.getItem("candoo-user-email");
      const isGated = gatedModules.includes(key);

      if (isGated && !emailStored) {
        tab.classList.add("locked");
        tab.innerHTML = `üîí ${name}`;
      } else {
        tab.innerHTML = name;
      }

      tab.onclick = () => switchTab(key, tab);
      tabsDiv.appendChild(tab);
    });

    const firstKey = visibleKeys.find(k => k !== '__admin__');
    const firstTab = tabsDiv.querySelector('.tab');
    if (firstTab && firstKey) {
      firstTab.classList.add('active');
      switchTab(firstKey, firstTab);
    }
  }

  async function switchTab(key, tabEl) {
    const module = calculators[key];
    if (!module) return;

    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tabEl.classList.add('active');

    const container = document.getElementById('contentContainer');
    container.innerHTML = '<p>Loading...</p>';

    if (module.protected) {
      const password = prompt("Enter admin password:");
    
      const response = await fetch("https://candoo-clarity.onrender.com/api/load-protected-module", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password, module: module.file })
      });
    
      if (!response.ok) {
        container.innerHTML = '<p style="color:red;">Access denied.</p>';
        return;
      }
    
      const html = await response.text();
    
      document.querySelectorAll('script[data-injected]').forEach(script => script.remove());
      container.innerHTML = html;
    
      const tempDiv = document.createElement("div");
      tempDiv.innerHTML = html;
    
      tempDiv.querySelectorAll("script").forEach(oldScript => {
        const newScript = document.createElement("script");
        if (oldScript.src) {
          newScript.src = oldScript.src;
        } else {
          newScript.textContent = oldScript.textContent;
        }
        newScript.setAttribute("data-injected", "true");
        document.body.appendChild(newScript);
      });
    
      return;
    }

    try {
      const response = await fetch(module.file);
      const html = await response.text();

      document.querySelectorAll('script[data-injected]').forEach(script => script.remove());
      container.innerHTML = html;
      document.querySelector('.intro')?.classList.remove('hidden');

      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;

      tempDiv.querySelectorAll('script').forEach(oldScript => {
        const newScript = document.createElement('script');
        if (oldScript.src) {
          newScript.src = oldScript.src;
        } else {
          newScript.textContent = oldScript.textContent;
        }
        newScript.setAttribute('data-injected', 'true');
        document.body.appendChild(newScript);

        if (oldScript.textContent.includes("window.renderCaptcha")) {
          const checkReady = setInterval(() => {
            if (
              typeof grecaptcha !== "undefined" &&
              typeof grecaptcha.render === "function" &&
              typeof renderCaptcha === "function"
            ) {
              renderCaptcha();
              clearInterval(checkReady);
            }
          }, 200);
        }
      });

    } catch (err) {
      console.error("‚ùå Error loading module:", err);
      container.innerHTML = '<p style="color:red;">Error loading module.</p>';
    }
  }

  function showEmailGate(nextTabKey) {
    const modal = document.getElementById("emailGateModal");
    const unlockBtn = document.getElementById("unlockBtn");
    const feedback = document.getElementById("unlock-feedback");

    modal.style.display = "flex";
    feedback.style.display = "none";

    unlockBtn.onclick = async (event) => {
  event.preventDefault();

  const email = document.getElementById("unlock-email").value.trim();
  const feedback = document.getElementById("unlock-feedback");

  if (!email || !email.includes("@")) {
    feedback.textContent = "Please enter a valid email.";
    feedback.style.display = "block";
    return;
  }

  localStorage.setItem("candoo-user-email", email);

  try {
    const res = await fetch("https://candoo-clarity.onrender.com/unlock-user", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email })
    });

    if (!res.ok) {
      throw new Error("Unlock logging failed.");
    }

    console.log("‚úÖ Unlock logged to backend.");
    location.reload();
  } catch (err) {
    console.error("‚ùå Error logging unlock:", err);
    feedback.textContent = "Unlock failed. Please try again.";
    feedback.style.display = "block";
  }
};
      
    };

    document.addEventListener("DOMContentLoaded", () => {
  const closeBtn = document.getElementById("closeEmailGate");
  const modal = document.getElementById("emailGateModal");
  if (closeBtn && modal) {
    closeBtn.onclick = () => {
      modal.style.display = "none";
    };
  }
});

  originalSwitchTab = switchTab;
  switchTab = function (key, tabEl) {
    const emailStored = localStorage.getItem("candoo-user-email");
    if (gatedModules.includes(key) && !emailStored) {
      showEmailGate(key);
      return;
    }
    originalSwitchTab(key, tabEl);
  };
    
  window.onload = loadVisibility;
</script>

  <script>
  function clearAllModuleResults() {
    const confirmed = confirm('Are you sure you want to clear all module results? This cannot be undone.');
    if (!confirmed) return;

    const keysToClear = [
      'payroll-waste-inputs',
      'customer-churn-inputs',
      'leadership-drag-inputs',
      'workforce-productivity-inputs',
      'productivity-deep-dive-inputs',
      'industry',
      'candoo-user-email'
    ];
    keysToClear.forEach(key => localStorage.removeItem(key));

    // Soft refresh: clear tabs and reload tab logic
    const tabsDiv = document.getElementById('tabs');
    const container = document.getElementById('contentContainer');

    if (tabsDiv) tabsDiv.innerHTML = '';
    if (container) container.innerHTML = '<p>Reset complete. Please select a module to begin again.</p>';

    loadVisibility(); // re-trigger tab rendering without reload
  }

  window.addEventListener('DOMContentLoaded', () => {
    const resetBtn = document.getElementById('resetAllBtn');
    if (resetBtn) {
      resetBtn.onclick = clearAllModuleResults;
    }
  });
</script>
  
 <!-- üîí Styled Email Gate Modal with Close Button -->
<div id="emailGateModal" style="
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.65);
  backdrop-filter: blur(4px);
  z-index: 9999;
  align-items: center;
  justify-content: center;
  font-family: 'DM Sans', sans-serif;
">
  <div style="
    background: white;
    padding: 30px 24px;
    border-radius: 16px;
    max-width: 380px;
    width: 90%;
    text-align: center;
    box-shadow: 0 12px 32px rgba(0,0,0,0.2);
    position: relative;
  ">
    <!-- ‚ùå Clean, Minimal Close Button -->
    <button id="closeEmailGate" style="
    position: absolute;
    top: 12px;
    right: 12px;
    background: transparent;
    border: none;
    font-size: 24px;
    font-weight: 400;
    color: #222;
    cursor: pointer;
    line-height: 1;
    outline: none;
    box-shadow: none;
    " 
    onfocus="this.style.outline='none'; this.style.boxShadow='none';" 
    aria-label="Close">
      &times;
    </button>

    <h3 style="font-size: 22px; margin-bottom: 12px; color: #111;">Unlock the Full Toolbox</h3>
    <p style="font-size: 14px; color: #444;">Enter your email to access all modules instantly.</p>
    <input
      type="email"
      id="unlock-email"
      placeholder="you@example.com"
      style="
        width: 100%;
        padding: 10px 14px;
        margin: 16px 0 12px 0;
        border-radius: 10px;
        border: 1px solid #ccc;
        font-size: 14px;
        background: #f9f9f9;
        color: #333;
      "
    />
    <button
      id="unlockBtn"
      style="
        padding: 10px 18px;
        background: #00d6ff;
        border: none;
        border-radius: 12px;
        color: #000;
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        transition: background 0.2s ease-in-out;
      "
    >Unlock Now</button>
    <p id="unlock-feedback" style="color: red; font-size: 13px; margin-top: 10px; display: none;"></p>
  </div>
</div>

</body>
</html>
