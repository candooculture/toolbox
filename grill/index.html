<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Candoo Clarity Toolbox</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="clarity-style.css">
  <link rel="icon" href="favicon.ico" type="image/x-icon">

  <!-- Meta Pixel Code -->
  <script>
  !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
  n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}
  (window, document,'script','https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '1120593203336237');
  fbq('track', 'PageView');
  </script>
  <!-- End Meta Pixel Code -->
</head>

<body>
<noscript>
  <img height="1" width="1" style="display:none"
       src="https://www.facebook.com/tr?id=1120593203336237&ev=PageView&noscript=1"/>
</noscript>

  <div class="logo">
  <a href="https://candooculture.com/">
    <img src="candoologo.png" alt="Candoo Logo">
    <span class="logo-tag">Home</span>
  </a>
  </div>

  <h1>Candoo Clarity Toolbox</h1>

  <div class="intro">
    <h2>Behind the Numbers: Your Hidden Costs, Revealed</h2>
    <p>This toolbox was built for one reason - Clarity.</p>
    <p>In every business, inefficiencies, churn, and leadership gaps are silently bleeding time, money, and momentum.</p>
    <p>We built this suite to surface invisible losses and offer a clear, actionable starting point.</p>
    <p>It‚Äôs not a crystal ball, and it‚Äôs not pretending to be tailored to every company‚Äôs nuance. But it‚Äôs close -
      industry benchmarks, smart assumptions, and proven ROI logic are built in to make the invisible‚Ä¶ visible.</p>
    <p>Use it to test scenarios. To validate instincts. To sense-check strategy. Whether you‚Äôre an owner, an operator,
      or a leader who‚Äôs had enough of vague problems and fluffy guesses - this is your starting line.</p>
  </div>

  <div class="ors-warning">
    <h3>üìò Before You Begin</h3>
    <ul>
      <li>‚úÖ Complete all <strong>5 diagnostic modules</strong> before generating your <strong>full</strong> Operational Risk Report. üì©</li>
      <li>‚ö†Ô∏è Your answers may <strong>not be saved permanently</strong> on some devices/browsers. If you leave a module before finishing, your data may be lost.</li>
      <li>üîê Enter a valid email to unlock all modules. No spam, no junk - just full access and your report when you're ready.</li>
      <li>üîÑ Need to start over? Use the <strong>"Reset All Results"</strong> button to clear your data, reset the system and begin again.</li>
    </ul>
  </div>

  <div class="tabs" id="tabs">
    <div class="tabs-row" id="tabs-top"></div>
    <div class="tabs-row" id="tabs-middle"></div>
    <div class="tabs-row" id="tabs-bottom"></div>
  </div>

  <div class="cta-row">
    <button id="resetAllBtn" class="btn-danger">üßØ Reset All Results üßØ</button>
  </div>

  <div id="contentContainer" class="content"></div>

  <script>
  // ===== Tabs + Loader =====
  const calculators = {
    payroll_waste: { name: "ü™ô Payroll Waste", file: "payroll-waste.html" },
    customer_churn: { name: "üìÑ Customer Churn", file: "customer-churn.html" },
    leadership_drag: { name: "üß† Leadership Drag", file: "leadership-drag.html" },
    team_efficiency: { name: "üìà Workforce Productivity", file: "workforce-productivity.html" },
    productivity_dive: { name: "üîç Productivity Deep Dive", file: "productivity-dive.html" },
    operational_risk: { name: "üî• Operational Risk", file: "operational-risk.html" },
    __admin__: { name: "‚öôÔ∏è Admin", file: "admin.html", protected: true }
  };

  const gatedModules = ["customer_churn", "workforce_productivity", "productivity_dive"];
  let originalSwitchTab;

  async function loadVisibility() {
  const rowTop = document.getElementById('tabs-top');
  const rowMid = document.getElementById('tabs-middle');
  const rowBot = document.getElementById('tabs-bottom');

  [rowTop, rowMid, rowBot].forEach(row => row.innerHTML = '');

  let visibleKeys = [];

  try {
    const res = await fetch('https://candoo-clarity.onrender.com/admin/get-visibility');
    const data = await res.json();
    if (data && Array.isArray(data.visible)) {
      visibleKeys = data.visible;
    } else {
      visibleKeys = ["payroll_waste","customer_churn","leadership_drag","team_efficiency","productivity_dive","operational_risk"];
    }
  } catch (e) {
    console.warn("Visibility fetch failed, defaulting to all:", e);
    visibleKeys = ["payroll_waste","customer_churn","leadership_drag","team_efficiency","productivity_dive","operational_risk"];
  }

  const emailStored = !!localStorage.getItem("candoo-user-email");

  Object.entries(calculators).forEach(([key, meta]) => {
    if (key === "__admin__") return; // hide admin from normal list

    if (!visibleKeys.includes(key)) return;

    const tab = document.createElement("button");
    tab.className = "tab";
    tab.dataset.module = key;
    const name = meta.name;

    const isGated = gatedModules.includes(key);
    if (isGated && !emailStored) {
      tab.classList.add("locked");
      tab.innerHTML = `üîí ${name}`;
    } else {
      tab.innerHTML = name;
    }

    // CHANGED: track module open
    tab.onclick = () => { trackModuleOpen(key); switchTab(key, tab); };

    // Place each tab in the correct row
    if (["team_efficiency", "customer_churn", "leadership_drag"].includes(key)) {
      rowTop.appendChild(tab);
    } else if (["productivity_dive"].includes(key)) {
      rowMid.appendChild(tab);
    } else {
      rowBot.appendChild(tab);
    }
  });

  // Auto-select first visible tab on load
  const firstTab = document.querySelector(".tab");
  if (firstTab) firstTab.click();
}

  async function switchTab(key, tabEl) {
    const module = calculators[key];
    if (!module) return;

    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tabEl.classList.add('active');

    const container = document.getElementById('contentContainer');
    container.innerHTML = '<p>Loading...</p>';

    if (module.protected) {
      const password = prompt("Enter admin password:");
      if (password !== "letmein") {
        container.innerHTML = '<p style="color:red;">Access denied.</p>';
        return;
      }

      try {
        const response = await fetch(module.file);
        const html = await response.text();

        document.querySelectorAll('script[data-injected]').forEach(script => script.remove());
        container.innerHTML = html;
        trackModuleLoaded(key);

        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = html;

        tempDiv.querySelectorAll("script").forEach(oldScript => {
          const newScript = document.createElement("script");
          if (oldScript.src) {
            newScript.src = oldScript.src;
          } else {
            newScript.textContent = oldScript.textContent;
          }
          newScript.setAttribute('data-injected', 'true');
          document.body.appendChild(newScript);
        });
      } catch (err) {
        container.innerHTML = '<p style="color:red;">Failed to load module.</p>';
      }
      return;
    }

    try {
      const response = await fetch(module.file);
      const html = await response.text();

      document.querySelectorAll('script[data-injected]').forEach(script => script.remove());
      container.innerHTML = html;
      document.querySelector('.intro')?.classList.remove('hidden');
      trackModuleLoaded(key);

      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;

      tempDiv.querySelectorAll('script').forEach(oldScript => {
        const newScript = document.createElement('script');
        if (oldScript.src) {
          newScript.src = oldScript.src;
        } else {
          newScript.textContent = oldScript.textContent;
        }
        newScript.setAttribute('data-injected','true');
        document.body.appendChild(newScript);
      });
    } catch (error) {
      container.innerHTML = '<p style="color:red;">Failed to load module.</p>';
    }
  }

  window.addEventListener('DOMContentLoaded', loadVisibility);
  </script>

  <script>
  // ===== Email Gate + Unlock =====
  function showEmailGate() {
    const modal = document.getElementById("emailGateModal");
    if (modal) modal.style.display = "flex";
  }

  function hideEmailGate() {
    const modal = document.getElementById("emailGateModal");
    if (modal) modal.style.display = "none";
  }

  function bindEmailForm() {
    const unlockBtn = document.getElementById("unlockBtn");
    if (!unlockBtn) return;

    const feedback = document.getElementById("unlock-feedback");
    if (feedback) {
      feedback.textContent = "";
      feedback.style.display = "none";
    }

    unlockBtn.onclick = async (event) => {
  event.preventDefault();

  const email = document.getElementById("unlock-email").value.trim();
  const feedback = document.getElementById("unlock-feedback");

  if (!email || !email.includes("@")) {
    feedback.textContent = "Please enter a valid email.";
    feedback.style.display = "block";
    return;
  }

  // Disable the button and show loading text
  unlockBtn.disabled = true;
  const originalText = unlockBtn.textContent;
  unlockBtn.textContent = "Unlocking...";

  localStorage.setItem("candoo-user-email", email);

  try {
    const res = await fetch("https://candoo-clarity.onrender.com/unlock-user", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email })
    });

    if (!res.ok) {
      throw new Error("Unlock logging failed.");
    }

    console.log("‚úÖ Unlock logged to backend.");
    trackEmailUnlock(email);
    location.reload();
  } catch (err) {
    console.error("‚ùå Error logging unlock:", err);
    feedback.textContent = "Unlock failed. Please try again.";
    feedback.style.display = "block";
    unlockBtn.disabled = false;
    unlockBtn.textContent = originalText;
  }
};
      
    };

    document.addEventListener("DOMContentLoaded", () => {
  const closeBtn = document.getElementById("closeEmailGate");
  const modal = document.getElementById("emailGateModal");
  if (closeBtn && modal) {
    closeBtn.onclick = () => {
      modal.style.display = "none";
    };
  }

  bindEmailForm();
});

  // Intercept locked tabs to show gate
  document.addEventListener("click", (e) => {
    const locked = e.target.closest(".tab.locked");
    if (!locked) return;
    e.preventDefault();
    showEmailGate();
  });

  // Rebind on module loads too
  document.addEventListener("DOMContentLoaded", bindEmailForm);
  </script>

  <script>
  // ===== Reset All Results =====
  function clearAllModuleResults() {
    const confirmed = confirm('Are you sure you want to clear all module results? This cannot be undone.');
    if (!confirmed) return;

    trackReset();

    const keysToClear = [
      'payroll-waste-inputs',
      'customer-churn-inputs',
      'leadership-drag-inputs',
      'workforce-productivity-inputs',
      'productivity-deep-dive-inputs',
      'industry',
      'candoo-user-email'
    ];
    keysToClear.forEach(key => localStorage.removeItem(key));

    // Soft refresh: clear tabs and reload tab logic
    const tabsDiv = document.getElementById('tabs');
    const container = document.getElementById('contentContainer');

    if (tabsDiv) tabsDiv.innerHTML = '';
    if (container) container.innerHTML = '<p>Reset complete. Please select a module to begin again.</p>';

    loadVisibility(); // re-trigger tab rendering without reload
  }

  window.addEventListener('DOMContentLoaded', () => {
    const resetBtn = document.getElementById('resetAllBtn');
    if (resetBtn) {
      resetBtn.onclick = clearAllModuleResults;
    }
  });
  </script>
  
 <!-- üîí Styled Email Gate Modal with Close Button -->
<div id="emailGateModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 9999; align-items: center; justify-content: center;">
  <div style="background: #0e0e0e; color: #fff; border: 1px solid #222; border-radius: 14px; width: min(92vw, 520px); padding: 22px 22px 26px; box-shadow: 0 20px 80px rgba(0,0,0,0.6);">
    <div style="display:flex; align-items:center; justify-content: space-between; margin-bottom: 10px;">
      <h3 style="margin:0; font-size: 20px; font-weight:600;">Unlock Full Access</h3>
      <button id="closeEmailGate" aria-label="Close" style="background: transparent; border: none; color: #aaa; font-size: 20px; cursor: pointer; line-height: 1;">‚úï</button>
    </div>
    <p style="margin-top: 0; color:#bbb; font-size: 14px;">
      Enter your email to unlock all modules and receive a copy of your Operational Risk Report when you‚Äôre done.
    </p>
    <input
      id="unlock-email"
      type="email"
      placeholder="you@work.com"
      autocomplete="email"
      style="
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #333;
        background: #111;
        color: #fff;
        border-radius: 10px;
        margin-bottom: 12px;
        outline: none;
      "
    />
    <button
      id="unlockBtn"
      style="
        padding: 10px 18px;
        background: #00d6ff;
        border: none;
        border-radius: 12px;
        color: #000;
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        transition: background 0.2s ease-in-out;
      "
    >Unlock Now</button>
    <p id="unlock-feedback" style="color: red; font-size: 13px; margin-top: 10px; display: none;"></p>
  </div>
</div>

<script>
  function fbqSafe(){ if (typeof fbq === 'function') fbq.apply(null, arguments); }
  function trackModuleOpen(key){ fbqSafe('trackCustom','ModuleOpen',{ module: key }); }
  function trackModuleLoaded(key){ fbqSafe('trackCustom','ModuleLoaded',{ module: key }); }
  function trackEmailUnlock(email){
    try { const domain = (email.split('@')[1] || '').toLowerCase(); fbqSafe('trackCustom','EmailUnlock',{ domain }); } catch(e){}
  }
  function trackReset(){ fbqSafe('trackCustom','ResetAll'); }
</script>

</body>
</html>
