<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Candoo Clarity Toolbox</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="clarity-style.css">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>

<body>
  <div class="logo">
    <a href="https://candooculture.com/">
      <img src="candoologo.png" alt="Candoo Logo">
    </a>
  </div>

  <h1>Candoo Clarity Toolbox</h1>

  <div class="intro">
    <h2>Behind the Numbers: Your Hidden Costs, Revealed</h2>
    <p>This toolbox was built for one reason - Clarity.</p>
    <p>In every business, inefficiencies, churn, and leadership gaps are silently bleeding time, money, and momentum.</p>
    <p>We built this suite to surface invisible losses and offer a clear, actionable starting point.</p>
    <p>Itâ€™s not a crystal ball, and itâ€™s not pretending to be tailored to every companyâ€™s nuance. But itâ€™s close -
      industry benchmarks, smart assumptions, and proven ROI logic are built in to make the invisibleâ€¦ visible.</p>
    <p>Use it to test scenarios. To validate instincts. To sense-check strategy. Whether youâ€™re an owner, an operator,
      or a leader whoâ€™s had enough of vague problems and fluffy guesses - this is your starting line.</p>
  </div>

  <div class="ors-warning">
    <h3>ğŸ“˜ Before You Begin</h3>
    <ul>
      <li>âœ… Complete all <strong>5 diagnostic modules</strong> before generating your <strong>full</strong> Operational Risk Report. ğŸ“©</li>
      <li>âš ï¸ Your answers may <strong>not be saved permanently</strong>. If you leave a module before finishing, your data may be lost.</li>
      <li>ğŸ”„ Need to start over? Use the <strong>"Reset All Results"</strong> button to clear your data, reset the system and begin again.</li>
    </ul>
  </div>
  
  <div class="reset-wrapper">
    <button id="resetAllBtn" class="reset-button">
      ğŸš¨ Reset All Results ğŸš¨
    </button>
  </div>

  <div class="module-wrapper">
    <div class="tabs" id="tabs"></div>
    <div class="content" id="contentContainer">Loading...</div>
  </div>

  <script>
    const calculators = {
      team_efficiency: { name: "ğŸ’¸ Payroll Waste", file: "payroll-waste.html" },
      customer_churn: { name: "ğŸ“‰ Customer Churn", file: "customer-churn.html" },
      leadership_drag: { name: "ğŸ§  Leadership Drag", file: "leadership-drag.html" },
      workforce_productivity: { name: "ğŸ“ˆ Workforce Productivity", file: "workforce-productivity.html" },
      productivity_dive: { name: "ğŸ” Productivity Deep Dive", file: "productivity-dive.html" },
      operational_risk: { name: "ğŸ”¥ Operational Risk", file: "operational-risk.html" },
      __admin__: { name: "âš™ï¸ Admin", file: "admin.html", protected: true }
    };

    async function loadVisibility() {
      const tabsDiv = document.getElementById('tabs');
      const container = document.getElementById('contentContainer');
      tabsDiv.innerHTML = '';

      let visibleKeys = [];

      try {
        const res = await fetch('https://candoo-clarity.onrender.com/admin/get-visibility');
        const data = await res.json();
        if (data.status === 'success' && Array.isArray(data.data)) {
          visibleKeys = data.data
            .filter(item => item.visible)
            .map(item => item.calculator);
        }
      } catch (err) {
        console.warn("âš ï¸ Could not load visibility settings from backend. Defaulting to all.");
        visibleKeys = Object.keys(calculators).filter(k => !calculators[k].protected);
      }

      Object.keys(calculators).forEach((key) => {
      if (!visibleKeys.includes(key) && key !== '__admin__') return;
    
      const { name } = calculators[key];
      const tab = document.createElement('div');
      tab.className = 'tab';
    
      const emailStored = localStorage.getItem("candoo-user-email");
      const isGated = ["customer_churn", "workforce_productivity", "productivity_dive"].includes(key);
    
      // ğŸ”’ Apply locked visual state
      if (isGated && !emailStored) {
        tab.classList.add("locked");
        tab.innerHTML = `ğŸ”’ ${name}`;
      } else {
        tab.innerHTML = name;
      }
    
      tab.onclick = () => switchTab(key, tab);
      tabsDiv.appendChild(tab);
    });

      const firstKey = visibleKeys.find(k => k !== '__admin__');
      const firstTab = tabsDiv.querySelector('.tab');
      if (firstTab && firstKey) {
        firstTab.classList.add('active');
        switchTab(firstKey, firstTab);
      }
    }

    async function switchTab(key, tabEl) {
      const module = calculators[key];
      if (!module) return;

      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tabEl.classList.add('active');

      const container = document.getElementById('contentContainer');
      container.innerHTML = '<p>Loading...</p>';

      if (module.protected) {
        const password = prompt("Enter admin password:");
        if (password !== "toolbox12103032") {
          container.innerHTML = '<p style="color:red;">Access denied.</p>';
          return;
        }
      }

      try {
        const response = await fetch(module.file);
        const html = await response.text();

        document.querySelectorAll('script[data-injected]').forEach(script => script.remove());
        container.innerHTML = html;
        document.querySelector('.intro')?.classList.remove('hidden');

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        tempDiv.querySelectorAll('script').forEach(oldScript => {
          const newScript = document.createElement('script');
          if (oldScript.src) {
            newScript.src = oldScript.src;
          } else {
            newScript.textContent = oldScript.textContent;
          }
          newScript.setAttribute('data-injected', 'true');
          document.body.appendChild(newScript);

          // âœ… Special handling: render reCAPTCHA manually if needed
          if (oldScript.textContent.includes("window.renderCaptcha")) {
            setTimeout(() => {
              if (typeof renderCaptcha === "function") renderCaptcha();
            }, 500);
          }
        });

      } catch (err) {
        console.error("âŒ Error loading module:", err);
        container.innerHTML = '<p style="color:red;">Error loading module.</p>';
      }
    }

    window.onload = loadVisibility;
  </script>

  <script>
    document.getElementById('resetAllBtn').addEventListener('click', () => {
      if (confirm('Are you sure you want to clear all module results? This cannot be undone.')) {
        const keysToClear = [
          'payroll-waste-inputs',
          'customer-churn-inputs',
          'leadership-drag-inputs',
          'workforce-productivity-inputs',
          'productivity-deep-dive-inputs',
          'industry',
          'candoo-user-email'
        ];
        keysToClear.forEach(key => localStorage.removeItem(key));
        location.reload();
      }
    });
  </script>
  
  <script>
  const gatedModules = ["customer_churn", "workforce_productivity", "productivity_dive"];

  const showEmailGate = (nextTabKey) => {
    const modal = document.getElementById("emailGateModal");
    const unlockBtn = document.getElementById("unlockBtn");
    const feedback = document.getElementById("unlock-feedback");

    modal.style.display = "flex";
    feedback.style.display = "none";

    unlockBtn.onclick = () => {
    const email = document.getElementById("unlock-email").value.trim();
    if (!email || !email.includes("@")) {
      feedback.textContent = "Please enter a valid email.";
      feedback.style.display = "block";
      return;
    }
  
    localStorage.setItem("candoo-user-email", email);
  
    // ğŸ” Send email to backend instead of direct to Google Sheets
    fetch("https://candoo-clarity.onrender.com/unlock-user", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email })
    }).catch(err => {
      console.error("Email logging failed:", err);
    });
  
    modal.style.display = "none";
  
    // ğŸ”„ Reload tabs so locked styles get removed
    loadVisibility();
  };
  
  document.getElementById("closeEmailGate").onclick = () => {
    document.getElementById("emailGateModal").style.display = "none";
  };

  // ğŸ§  Override switchTab to inject email gate logic
  const originalSwitchTab = switchTab;
  switchTab = function (key, tabEl) {
    const emailStored = localStorage.getItem("candoo-user-email");
    if (gatedModules.includes(key) && !emailStored) {
      showEmailGate(key);
      return;
    }
    originalSwitchTab(key, tabEl);
  };
</script>

 <!-- ğŸ”’ Styled Email Gate Modal with Close Button -->
<div id="emailGateModal" style="
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.65);
  backdrop-filter: blur(4px);
  z-index: 9999;
  align-items: center;
  justify-content: center;
  font-family: 'DM Sans', sans-serif;
">
  <div style="
    background: white;
    padding: 30px 24px;
    border-radius: 16px;
    max-width: 380px;
    width: 90%;
    text-align: center;
    box-shadow: 0 12px 32px rgba(0,0,0,0.2);
    position: relative;
  ">
    <!-- âŒ Close Button -->
    <button id="closeEmailGate" style="
      position: absolute;
      top: 12px;
      right: 14px;
      background: transparent;
      border: none;
      font-size: 20px;
      color: #666;
      cursor: pointer;
      outline: none;
      box-shadow: none;
      "onfocus="this.style.outline='none'; this.style.boxShadow='none';" aria-label="Close">
      &times;
    </button>

    <h3 style="font-size: 22px; margin-bottom: 12px; color: #111;">Unlock the Full Toolbox</h3>
    <p style="font-size: 14px; color: #444;">Enter your email to access all modules instantly.</p>
    <input
      type="email"
      id="unlock-email"
      placeholder="you@example.com"
      style="
        width: 100%;
        padding: 10px 14px;
        margin: 16px 0 12px 0;
        border-radius: 10px;
        border: 1px solid #ccc;
        font-size: 14px;
        background: #f9f9f9;
        color: #333;
      "
    />
    <button
      id="unlockBtn"
      style="
        padding: 10px 18px;
        background: #00d6ff;
        border: none;
        border-radius: 12px;
        color: #000;
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        transition: background 0.2s ease-in-out;
      "
    >Unlock Now</button>
    <p id="unlock-feedback" style="color: red; font-size: 13px; margin-top: 10px; display: none;"></p>
  </div>
</div>


<script>
  function sendEmailToSheet(email) {
    const timestamp = new Date().toISOString();
    const data = new URLSearchParams();
    data.append("email", email);
    data.append("timestamp", timestamp);
    data.append("source", "module-unlock");

    fetch("https://script.google.com/macros/s/AKfycbwbtb1kDD5fOJrtCVtfcVq2H5vdgrpYhw89zpnJryUEiuset9AUBWSkNRPTU_5So-t-/exec", {
      method: "POST",
      body: data,
    }).then((response) => {
      if (!response.ok) throw new Error("Network response was not ok");
      return response.text();
    }).then((text) => {
      console.log("Logged to sheet:", text);
    }).catch((error) => {
      console.error("Logging failed:", error);
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    const emailInput = document.querySelector("#email");
    const unlockButton = document.querySelector("#unlock-button");

    if (unlockButton && emailInput) {
      unlockButton.addEventListener("click", () => {
        const email = emailInput.value.trim();
        if (email) {
          sendEmailToSheet(email);
        }
      });
    }
  });
</script>

</body>
</html>
