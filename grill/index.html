<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Candoo Clarity Toolbox</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="clarity-style.css">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <script defer src="meta-pixel.js"></script>
</head>

<body>
  <div class="logo">
  <a href="https://candooculture.com/">
    <img src="candoologo.png" alt="Candoo Logo">
    <span class="logo-tag">Home</span>
  </a>
</div>

  <div class="layout-grid">
    <div class="main">
      <div class="intro">
        <h1>Candoo Clarity Toolbox</h1>
        <h2>Behind the Numbers: Your Hidden Costs, Revealed</h2>
        <p>This toolbox was built for one reason ‚Äì Clarity.</p>
        <p>In every business, inefficiencies, churn, and leadership gaps are silently bleeding time, money, and momentum.</p>
        <p>We built this suite to surface invisible losses and offer a clear, actionable starting point.</p>
        <p>It‚Äôs not a crystal ball, and it‚Äôs not pretending to be tailored to every company‚Äôs nuance. But it‚Äôs close -
          industry benchmarks, smart assumptions, and proven ROI logic are built in to make the invisible‚Ä¶ visible.</p>
        <p>Use it to test scenarios. To validate instincts. To sense-check strategy. Whether you‚Äôre an owner, an operator,
          or a leader who‚Äôs had enough of vague problems and fluffy guesses - this is your starting line.</p>
      </div>

      <div class="ors-warning">
        <h3>üìò Before You Begin</h3>
        <ul>
          <li>‚úÖ Complete all <strong>5 diagnostic modules</strong> before generating your <strong>full</strong> Operational Risk Report üì©.</li>
          <li>‚ö†Ô∏è Your answers may <strong>not be saved permanently</strong>. If you leave a module before finishing, your data may be lost.</li>
          <li>üîê Enter a valid email to unlock all modules. No spam, no sneaky stuff - just full access and your report when you're ready.</li>
          <li>üëª Ghost figures showing up? Use the <strong>"Reset All Results"</strong> button to clear your data, reset the system and begin again.</li>
        </ul>
      </div>
      
      <div class="reset-wrapper">
        <!-- added inline onclick as a backstop -->
        <button id="resetAllBtn" class="reset-button" onclick="return clearAllModuleResults(event);">
          üö® Reset All Results üö®
        </button>
      </div>

      <div class="module-wrapper">
        <div class="pyramid-tabs">
        <div class="tab-row top" id="tabs-top"></div>
        <div class="tab-row middle" id="tabs-middle"></div>
        <div class="tab-row bottom" id="tabs-bottom"></div>
      </div>

      <div id="contentContainer" class="content">
        <p>Select a module above to get started.</p>
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="linkbox">
      <!-- LOCKED: route through protected loader, not a raw href -->
      <a href="#" id="adminLink" class="admin-link">admin</a>
    </div>
  </div>

  <script>
  const calculators = {
    team_efficiency: { name: "üí∏ Payroll Waste", file: "payroll-waste.html" },
    customer_churn: { name: "üìâ Customer Churn", file: "customer-churn.html" },
    leadership_drag: { name: "üß† Leadership Drag", file: "leadership-drag.html" },
    workforce_productivity: { name: "üìà Workforce Productivity", file: "workforce-productivity.html" },
    productivity_dive: { name: "üîç Productivity Deep Dive", file: "productivity-dive.html" },
    operational_risk: { name: "üî• Operational Risk", file: "operational-risk.html" },
    profit_potential: { name: "üîêüí∞ Profit Potential üîê", file: "profit-potential.html", protected: true },
    __admin__: { name: "‚öôÔ∏è Admin", file: "admin.html", protected: true }
  };

  const gatedModules = ["customer_churn", "workforce_productivity", "productivity_dive"];
  let originalSwitchTab;

  async function loadVisibility() {
    const rowTop = document.getElementById('tabs-top');
    const rowMid = document.getElementById('tabs-middle');
    const rowBot = document.getElementById('tabs-bottom');

    [rowTop, rowMid, rowBot].forEach(row => row.innerHTML = '');

    let visibleKeys = [];

    try {
      const res = await fetch('https://candoo-clarity.onrender.com/admin/get-visibility');
      const data = await res.json();
      if (data.status === 'success' && Array.isArray(data.data)) {
        visibleKeys = data.data
          .filter(item => item.visible)
          .map(item => item.calculator);
      }
    } catch (err) {
      console.warn("‚ö†Ô∏è Could not load visibility settings from backend. Defaulting to all.");
      visibleKeys = Object.keys(calculators).filter(k => !calculators[k].protected);
    }

    Object.keys(calculators).forEach((key) => {
      if (!visibleKeys.includes(key) || key === '__admin__') return;

      const { name } = calculators[key];
      const tab = document.createElement('div');
      tab.className = 'tab';
      tab.setAttribute('data-key', key);
      tab.setAttribute('data-key', key);

      const emailStored = localStorage.getItem("candoo-user-email");
      const isGated = gatedModules.includes(key);

      if (isGated && !emailStored) {
        tab.classList.add("locked");
        tab.innerHTML = `üîí ${name}`;
      } else {
        tab.innerHTML = name;
      }

      tab.onclick = () => switchTab(key, tab);

      // Place each tab in the correct row
      if (["team_efficiency", "customer_churn", "leadership_drag"].includes(key)) {
        rowTop.appendChild(tab);
      } else if (["workforce_productivity", "productivity_dive"].includes(key)) {
        rowMid.appendChild(tab);
      } else if (["operational_risk", "profit_potential"].includes(key)) {
        rowBot.appendChild(tab);
      }
    });

    const firstKey = visibleKeys.find(k => k !== '__admin__');
    const firstTab = document.querySelector('.tab');
    if (firstTab && firstKey) {
      firstTab.classList.add('active');
      switchTab(firstKey, firstTab);
    }
  }

  async function switchTab(key, tabEl) {
    const module = calculators[key];
    if (!module) return;

    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tabEl.classList.add('active');

    const container = document.getElementById('contentContainer');
    container.innerHTML = '<p>Loading...</p>';

    if (module.protected) {
      const password = prompt("Enter your access code (if you do not have access please contact the Candoo Culture team):");
    
      const response = await fetch("https://candoo-clarity.onrender.com/api/load-protected-module", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password, module: module.file })
      });
    
      if (!response.ok) {
        container.innerHTML = '<p style="color:red;">Access denied.</p>';
        return;
      }
    
      const html = await response.text();
    
      document.querySelectorAll('script[data-injected]').forEach(script => script.remove());
      container.innerHTML = html;
    
      const tempDiv = document.createElement("div");
      tempDiv.innerHTML = html;
    
      tempDiv.querySelectorAll("script").forEach(oldScript => {
        const newScript = document.createElement("script");
        if (oldScript.src) {
          newScript.src = oldScript.src;
        } else {
          newScript.textContent = oldScript.textContent;
        }
        newScript.setAttribute("data-injected", "true");
        document.body.appendChild(newScript);
      });
    
      return;
    }

    try {
      const response = await fetch(module.file);
      const html = await response.text();

      document.querySelectorAll('script[data-injected]').forEach(script => script.remove());
      container.innerHTML = html;
      document.querySelector('.intro')?.classList.remove('hidden');

      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;

      tempDiv.querySelectorAll('script').forEach(oldScript => {
        const newScript = document.createElement('script');
        if (oldScript.src) {
          newScript.src = oldScript.src;
        } else {
          newScript.textContent = oldScript.textContent;
        }
        newScript.setAttribute('data-injected', 'true');
        document.body.appendChild(newScript);

        if (oldScript.textContent.includes("window.renderCaptcha")) {
          const checkReady = setInterval(() => {
            if (
              typeof grecaptcha !== "undefined" &&
              typeof grecaptcha.render === "function" &&
              typeof renderCaptcha === "function"
            ) {
              renderCaptcha();
              clearInterval(checkReady);
            }
          }, 200);
        }
      });

    } catch (err) {
      console.error("‚ùå Error loading module:", err);
      container.innerHTML = '<p style="color:red;">Error loading module.</p>';
    }
  }

  function showEmailGate(nextTabKey) {
    const modal = document.getElementById("emailGateModal");
    const unlockBtn = document.getElementById("unlockBtn");
    const feedback = document.getElementById("unlock-feedback");

    modal.style.display = "flex";
    feedback.style.display = "none";

    unlockBtn.onclick = async (event) => {
      event.preventDefault();

      const email = document.getElementById("unlock-email").value.trim();
      const feedback = document.getElementById("unlock-feedback");

      if (!email || !email.includes("@")) {
        feedback.textContent = "Please enter a valid email.";
        feedback.style.display = "block";
        return;
      }

      // Disable the button and show loading text
      unlockBtn.disabled = true;
      const originalText = unlockBtn.textContent;
      unlockBtn.textContent = "Unlocking...";

      localStorage.setItem("candoo-user-email", email);

      try {
        const res = await fetch("https://candoo-clarity.onrender.com/unlock-user", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email })
        });

        if (!res.ok) {
          throw new Error("Unlock logging failed.");
        }

        console.log("‚úÖ Unlock logged to backend.");
        location.reload();
      } catch (err) {
        console.error("‚ùå Error logging unlock:", err);
        feedback.textContent = "Unlock failed. Please try again.";
        feedback.style.display = "block";
        unlockBtn.disabled = false;
        unlockBtn.textContent = originalText;
      }
    };
      
  };

  document.addEventListener("DOMContentLoaded", () => {
    const closeBtn = document.getElementById("closeEmailGate");
    const modal = document.getElementById("emailGateModal");
    if (closeBtn && modal) {
      closeBtn.onclick = () => {
        modal.style.display = "none";
      };
    }
  });

  originalSwitchTab = switchTab;
  switchTab = function (key, tabEl) {
    const emailStored = localStorage.getItem("candoo-user-email");
    if (gatedModules.includes(key) && !emailStored) {
      showEmailGate(key);
      return;
    }
    originalSwitchTab(key, tabEl);
  };
    
  window.onload = loadVisibility;
</script>

  <script>
  function clearAllModuleResults(evt) {
    try { if (evt) evt.preventDefault(); } catch (_) {}

    if (!confirm('This will wipe ALL saved answers and unlock state on this device.\n\nContinue?')) return false;

    try {
      // Hard nuke: clear all saved keys for this origin
      localStorage.clear();
      if (typeof sessionStorage !== "undefined") {
        sessionStorage.clear();
      }
    } catch (e) {
      console.warn("localStorage/sessionStorage clear failed, falling back:", e);
      // Best-effort fallback: remove keys one-by-one
      try {
        for (let i = localStorage.length - 1; i >= 0; i--) {
          const k = localStorage.key(i);
          if (k) localStorage.removeItem(k);
        }
      } catch (_) {}
    }

    // Remove any previously injected module scripts
    document.querySelectorAll('script[data-injected]').forEach(s => s.remove());

    // UI message then force a clean reload
    const container = document.getElementById('contentContainer');
    if (container) container.innerHTML = '<p>All results cleared. Reloading‚Ä¶</p>';

    setTimeout(() => location.reload(), 150);
    return false;
  }
</script>

<!-- üîí Lock Admin behind the protected loader (same as Profit) -->
<script>
  (function lockAdmin(){
    function openAdmin(e){
      try { e?.preventDefault(); e?.stopPropagation?.(); } catch(_){}
      // Use a throwaway element so switchTab can safely mark it active
      const phantomTab = document.createElement('div');
      phantomTab.className = 'tab';
      switchTab('__admin__', phantomTab); // triggers password + /api/load-protected-module
      return false;
    }
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('adminLink')?.addEventListener('click', openAdmin);
      // Intercept any stray direct links to admin.html
      document.body.addEventListener('click', (ev) => {
        const a = ev.target.closest('a[href$="admin.html"]');
        if (a) { ev.preventDefault(); openAdmin(ev); }
      }, true);
    });
  })();
</script>
  
 <!-- üîí Styled Email Gate Modal with Close Button -->
<div id="emailGateModal" style="
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.65);
  backdrop-filter: blur(4px);
  z-index: 9999;
  align-items: center;
  justify-content: center;
  font-family: 'DM Sans', sans-serif;
">
  <div class="sheet" style="
    background: white;
    padding: 30px 24px;
    border-radius: 16px;
    border: 1px solid rgba(0,0,0,0.08);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    width: 92%;
    max-width: 380px;
    text-align: center;
    position: relative;
  ">
    <!-- ‚ùå Clean, Minimal Close Button -->
    <button id="closeEmailGate" style="
      position: absolute;
      top: 8px;
      right: 8px;
      background: transparent;
      border: none;
      font-size: 20px;
      color: #888;
      cursor: pointer;
    ">&times;</button>

    <div style="margin-bottom: 14px;">
      <div style="width: 46px; height: 46px; border-radius: 50%; background: #e6fbff; display:inline-flex; align-items:center; justify-content:center; margin: 0 auto 10px;">
        <span style="font-size: 24px;">üîì</span>
      </div>
      <h3 style="margin: 8px 0 4px; font-size: 20px; color: #111;">Unlock the Full Toolbox</h3>
      <p style="margin: 0; font-size: 13px; color: #666;">Enter your email to access all modules instantly.</p>
    </div>

    <form style="margin-top: 10px;" onsubmit="return false;">
      <label for="unlock-email" style="display:block; text-align:left; font-size:12px; color:#777; margin-bottom:6px;">Email</label>
      <input id="unlock-email" type="email" placeholder="you@example.com" style="
        width: 100%;
        box-sizing: border-box;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #ddd;
        outline: none;
        font-size: 14px;
      ">

      <button id="unlockBtn" style="
        margin-top: 12px;
        width: 100%;
        padding: 11px 12px;
        background: #13dcff;
        border: none;
        border-radius: 12px;
        color: #000;
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        transition: background 0.2s ease-in-out;
      "
    >Unlock Now</button>
    <p id="unlock-feedback" style="color: red; font-size: 13px; margin-top: 10px; display: none;"></p>
  </div>
</div>


<style id="email-gate-isolated">
  /* Reset inherited theme inside the modal only */
  #emailGateModal .sheet, #emailGateModal .sheet * { all: revert; box-sizing: border-box; }
  #emailGateModal .sheet {
    font-family: "DM Sans", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:#fff; color:#111; width:min(92vw,420px);
    border-radius:16px; border:1px solid rgba(0,0,0,.08);
    box-shadow:0 10px 30px rgba(0,0,0,.15); padding:24px; text-align:center;
    position:relative; max-width:420px;
  }
  #emailGateModal .sheet h3 { margin: 8px 0 6px; font-size: 20px; font-weight: 700; }
  #emailGateModal .sheet .icon {
    width:46px; height:46px; border-radius:50%; background:#e6fbff;
    display:inline-flex; align-items:center; justify-content:center; margin:0 auto 10px;
  }
  #emailGateModal .sheet label { display:block; text-align:left; font-size:12px; color:#777; margin-bottom:6px; }
  #emailGateModal .sheet input[type="email"]{
    width:100%; height:44px; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px;
    background:#fff; color:#111; font-size:14px;
  }
  #emailGateModal .sheet input::placeholder{ color:#9aa3a9; }
  #emailGateModal .sheet #unlockBtn{
    display:block; width:100%; margin-top:12px; padding:11px 12px; border:0; border-radius:12px;
    background:#13dcff; color:#000; font-weight:600; cursor:pointer;
  }
  #emailGateModal .sheet #closeEmailGate{
    all:unset; position:absolute; top:8px; right:8px; cursor:pointer; font-size:22px; color:#888; line-height:1;
  }
  #emailGateModal .sheet #closeEmailGate:hover{ color:#111; }
  #emailGateModal .sheet #unlock-feedback{ color:#e11d48; font-size:13px; margin-top:10px; display:none; }
</style>

</body>
</html>
