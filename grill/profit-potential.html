<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Profit Potential – Now vs Fixed vs Risk-Free</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="clarity-style.css">
  <style>
  /* Profit Potential — fully scoped, dark, Montserrat (compact) */
  .profit{
    --maxw: 980px;
    --pad: 12px;
    --gap: 10px;
    --radius: 10px;
    font-family:'Montserrat', sans-serif;
    color:#fff;
  }
  .profit .wrap{ max-width:var(--maxw); margin:0 auto; padding:0 var(--pad); }

  .profit h1,.profit h2,.profit h3{ margin:0 0 8px; }
  .profit p{ margin:0 0 6px; opacity:.85; }

  .profit .card{
    background:rgba(15,15,15,.85);
    border:1px solid #333;
    border-radius:var(--radius);
    padding:14px;
    margin-bottom:12px;
    box-shadow:0 1px 6px rgba(0,0,0,.5);
  }

  .profit .grid{ display:grid; grid-template-columns:repeat(12,1fr); gap:var(--gap); }
  .profit .col-6{ grid-column:span 6; }
  .profit .col-4{ grid-column:span 4; }
  .profit .col-3{ grid-column:span 3; }
  .profit .col-12{ grid-column:span 12; }
  @media (max-width:860px){
    .profit .col-6, .profit .col-4, .profit .col-3, .profit .col-12{ grid-column:span 12; }
  }

  .profit label{
    display:block;
    font-size:.92rem;
    margin-bottom:4px;
    color:#bfc7cc;
  }

  .profit input[type="number"],
  .profit input[type="text"],
  .profit input[type="email"]{
    width:100%;
    box-sizing:border-box;
    padding:8px 10px;
    height:44px;
    background:#0f0f0f;
    border:1px solid #333;
    border-radius:8px;
    color:#fff;
    font-size:.95rem;
    line-height:1.2;
  }

  /* hide number spinners to save space */
  .profit input[type="number"]::-webkit-outer-spin-button,
  .profit input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  .profit input[type="number"] { -moz-appearance: textfield; }

  .profit input[type="checkbox"]{ margin-right:8px; }

  .profit .hint{ font-size:.82rem; opacity:.72; }

  .profit .actions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:6px;
  }
  .profit button{
    background:#13dcff; color:#000; font-weight:600;
    padding:9px 12px; border:none; border-radius:9px; cursor:pointer;
  }
  .profit button.ghost{ background:transparent; border:1px solid #333; color:#fff; }

  .profit table{
    width:100%;
    border-collapse:collapse;
    margin-top:6px;
    border:1px solid #333;
    border-radius:var(--radius);
    overflow:hidden;
    background:#0b0b0b;
    color:#eee;
  }
  .profit thead th{
    text-align:left;
    font-weight:600;
    padding:10px;
    background:#0f0f0f;
    border-bottom:1px solid #333;
  }
  .profit tbody td{
    padding:10px;
    border-bottom:1px solid #222;
    text-align:right;
    font-variant-numeric:tabular-nums;
  }
  .profit tbody td:first-child, .profit thead th:first-child{ text-align:left; }
  .profit tfoot td{ font-weight:700; background:#101010; }

  .profit .pos{ color:#13dcff; }
  .profit .neg{ color:#ff6b6b; }

  /* Hide duplicate module logo (index already shows brand) */
  .profit .logo{ display:none; }

  /* Custom */
  .btn-recalc{
    background:#c55c5c;
    color:#fff;
    font-weight:600;
    padding:9px 12px;
    border:none; border-radius:9px; cursor:pointer;
  }
  .btn-recalc:hover{ filter:brightness(.95); }

  .btn-send{
    background:#13dcff;
    color:#000;
    font-weight:600;
    padding:9px 12px;
    border:none; border-radius:9px; cursor:pointer;
  }
  .btn-send:hover{ filter:brightness(.95); }

  .big-checkbox{
    width:22px; height:22px;
    cursor:pointer;
  }
  </style>
</head>
<body>
  <div class="profit dense">
    <div class="wrap">
      <div class="logo">
        <a href="https://candooculture.com/">
          <img src="candoologo.png" alt="Candoo Logo" style="width:48px;height:auto;opacity:.9">
          <span class="logo-tag">Return Home</span>
        </a>
      </div>

      <h1>Profit Potential</h1>

      <!-- ===== Inputs: Current Financials ===== -->
      <div class="card">
        <h2>Current Financials</h2>
        <p class="hint">Enter what you know. If you only know Net Profit, you can put it below and leave Revenue/COGS/OpEx blank.</p>
        <div class="grid" style="margin-top:8px;">
          <div class="col-4">
            <label for="revenue">Revenue (period)</label>
            <input type="number" id="revenue" step="0.01" placeholder="e.g. 5,000,000">
          </div>
          <div class="col-4">
            <label for="cogs">COGS</label>
            <input type="number" id="cogs" step="0.01" placeholder="e.g. 2,500,000">
          </div>
          <div class="col-4">
            <label for="opex">Operating Expenses (excl COGS)</label>
            <input type="number" id="opex" step="0.01" placeholder="e.g. 1,900,000">
          </div>
          <div class="col-4">
            <label for="grossNow">Gross Profit (auto)</label>
            <input type="number" id="grossNow" step="0.01" disabled>
          </div>
          <div class="col-4">
            <label for="netNow">Net Profit (auto)</label>
            <input type="number" id="netNow" step="0.01" placeholder="e.g. 600,000">
          </div>
          <div class="col-4">
            <label for="periodLabel">Period Label</label>
            <input type="text" id="periodLabel" placeholder="e.g. FY25, Q3, Project X">
          </div>
        </div>
      </div>

      <!-- ===== Inputs: Fixable Savings ===== -->
      <div class="card">
        <h2>Fixable Savings - auto complete from Toolbox</h2>
        <div class="grid" style="margin-top:8px;">
          <div class="col-4">
            <label for="payrollSavings">Payroll Waste – Savings</label>
            <input type="number" id="payrollSavings" step="0.01" placeholder="e.g. 120,000">
          </div>
          <div class="col-4">
            <label for="churnSavings">Customer Churn – Recovery</label>
            <input type="number" id="churnSavings" step="0.01" placeholder="e.g. 250,000">
          </div>
          <div class="col-4">
            <label for="leadershipSavings">Leadership Drag – Reduction</label>
            <input type="number" id="leadershipSavings" step="0.01" placeholder="e.g. 160,000">
          </div>
          <div class="col-4">
            <label for="workforceSavings">Workforce Productivity – Gain</label>
            <input type="number" id="workforceSavings" step="0.01" placeholder="e.g. 300,000">
          </div>
          <div class="col-4">
            <label for="deepDiveSavings">Productivity Deep Dive – Gain</label>
            <input type="number" id="deepDiveSavings" step="0.01" placeholder="e.g. 90,000">
          </div>
          <!-- Checkbox: descriptor above, checkbox below (right aligned) -->
          <div class="col-4" style="display:flex; flex-direction:column; align-items:flex-end; justify-content:flex-end;">
            <label for="applyFixes">Apply “Fix Inefficiencies”</label>
            <input type="checkbox" id="applyFixes" class="big-checkbox">
          </div>
        </div>

        <div class="actions" style="justify-content:flex-end;">
          <button id="recalcFix" class="btn-recalc">Recalculate</button>
        </div>
      </div>

      <!-- ===== Output: Fix Savings Comparison ===== -->
      <div class="card">
        <h2>Profit Comparison – Fixable Savings</h2>
        <table id="resultsFixTable">
          <thead>
            <tr>
              <th>Scenario</th>
              <th>Gross Profit</th>
              <th>Net Profit</th>
              <th>Δ vs Now</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Now</td>
              <td id="gpNowCell">–</td>
              <td id="npNowCell">–</td>
              <td>–</td>
            </tr>
            <tr>
              <td>Fix Inefficiencies</td>
              <td id="gpFixCell">–</td>
              <td id="npFixCell">–</td>
              <td id="npFixDelta">–</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- ===== Inputs: ORS Risk ===== -->
      <div class="card">
        <h2>Operational Risk</h2>
        <div class="grid" style="margin-top:8px;">
          <div class="col-4">
            <label for="orsRisk">ORS – EBITDA at Risk</label>
            <input type="number" id="orsRisk" step="0.01" placeholder="e.g. 800,000">
          </div>
          <!-- Checkbox: descriptor above, checkbox below (right aligned) -->
          <div class="col-4" style="display:flex; flex-direction:column; align-items:flex-end; justify-content:flex-end;">
            <label for="applyORS">Eliminate ORS Risk</label>
            <input type="checkbox" id="applyORS" class="big-checkbox">
          </div>
        </div>

        <div class="actions" style="justify-content:flex-end;">
          <button id="recalcORS" class="btn-recalc">Recalculate</button>
        </div>
      </div>

      <!-- ===== Output: ORS Risk Comparison ===== -->
      <div class="card">
        <h2>Profit Comparison – ORS Risk</h2>
        <table id="resultsORSTable">
          <thead>
            <tr>
              <th>Scenario</th>
              <th>Gross Profit</th>
              <th>Net Profit</th>
              <th>Δ vs Now</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Now</td>
              <td id="gpNowORS">–</td>
              <td id="npNowORS">–</td>
              <td>–</td>
            </tr>
            <tr>
              <td>Eliminate ORS Risk</td>
              <td id="gpORSCell">–</td>
              <td id="npORSCell">–</td>
              <td id="npORSDelta">–</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- ===== Email Report ===== -->
      <div class="card">
        <h2>Email Report</h2>
        <div class="grid" style="margin-top:8px;">
          <div class="col-6">
            <label for="reportEmail">Send to</label>
            <input type="email" id="reportEmail" placeholder="e.g. name@company.com">
          </div>
          <div class="col-6" style="display:flex; align-items:flex-end; justify-content:flex-end;">
            <button id="sendReport" class="btn-send">Send Report</button>
          </div>
        </div>
        <p class="hint">Uses your saved email from ORS if available. You’ll receive a formatted summary of this page.</p>
      </div>
    </div>
  </div>

  <script>
  // ---- Storage Keys (soft conventions; we try multiple) ----
  const KEYMAP = {
    ors: ["ors_ebitda_at_risk", "ors-ebitda-risk", "orsTotalRisk", "ORS_EBITDA_AT_RISK"],
    savings: {
      payroll: ["payroll-waste-savings", "payrollSavings", "payroll_waste_savings"],
      churn: ["customer-churn-savings", "churnSavings", "customer_churn_savings"],
      workforce: ["workforce-productivity-savings", "workforceSavings", "workforce_productivity_savings"],
      deep: ["productivity-deep-dive-savings", "deepDiveSavings", "productivity_deep_dive_savings"],
      leadership: ["leadership-drag-savings", "leadershipSavings", "leadership_drag_savings"]
    }
  };

  // Track whether user has manually edited Net Profit
  let netNowTouched = false;

  // ---------- helpers ----------
  function lsFirstNumber(keys){
    for (const k of keys){
      const raw = localStorage.getItem(k);
      if (!raw) continue;
      const v = Number(String(raw).replace(/,/g,"").trim());
      if (!Number.isNaN(v)) return v;
      try{
        const obj = JSON.parse(raw);
        const candidates = ["value","amount","total","ebitda_at_risk","ebitdaRisk","risk","savings","gain"];
        for (const c of candidates){
          if (obj && typeof obj==="object" && obj[c]!=null){
            const n = Number(String(obj[c]).replace(/,/g,""));
            if (!Number.isNaN(n)) return n;
          }
        }
      }catch(_){}
    }
    return null;
  }

  function fmt(n){
    if (n==null || Number.isNaN(n)) return "–";
    return n.toLocaleString(undefined,{style:"currency",currency:"AUD",maximumFractionDigits:0});
  }

  function num(id){
    const el = document.getElementById(id);
    if (!el) return 0;
    const v = Number(String(el.value).replace(/,/g,"").trim());
    return Number.isFinite(v)? v:0;
  }

  function setVal(id,value){
    const el = document.getElementById(id);
    if (!el) return;
    el.value = value ?? "";
    localStorage.setItem(id, el.value);
  }

  // ---------- snapshot preload ----------
  function readSnapshotFromLocal(){
    const keys = ["ors_last_snapshot","ors_snapshot"];
    for (const k of keys){
      const raw = localStorage.getItem(k);
      if (!raw) continue;
      try{
        const s = JSON.parse(raw);
        if (s && (s.inputs || s.savings || s.risk)) return s;
      }catch(_){}
    }
    return null;
  }

  function applySnapshotToInputs(s){
    let changed = 0;
    const put = (id, val) => {
      if (val==null) return;
      const el = document.getElementById(id);
      if (!el) return;
      if (String(el.value).trim() !== "") return; // don't overwrite user input
      setVal(id, String(val));
      changed++;
    };

    if (s.inputs){
      put("revenue",   s.inputs.revenue);
      put("cogs",      s.inputs.cogs);
      put("opex",      s.inputs.opex);
      put("grossNow",  s.inputs.gross_now);
      put("netNow",    s.inputs.net_now);
    }
    if (s.savings){
      put("payrollSavings",   s.savings.payroll_savings);
      put("churnSavings",     s.savings.churn_recovery);
      put("workforceSavings", s.savings.workforce_gain);
      put("deepDiveSavings",  s.savings.deep_dive_gain);
      put("leadershipSavings",s.savings.leadership_reduction);
    }
    if (s.risk){
      put("orsRisk", s.risk.ors_ebitda_at_risk);
    }
    return changed>0;
  }

  // ---------- calcs ----------
  function computeNow(){
    const rev  = num("revenue");
    const cogs = num("cogs");
    const opex = num("opex");

    let gp=null, np=null;

    if (rev || cogs || opex){
      gp = (rev || 0) - (cogs || 0);
      np = gp - (opex || 0);

      setVal("grossNow", String(gp));

      // Only auto-fill Net Profit if user hasn't typed in it this session
      if (!netNowTouched) {
        setVal("netNow", String(np));
      }
    } else {
      gp = num("grossNow") || null;
      np = num("netNow")  || 0;
    }
    return { gpNow: gp, npNow: np };
  }

  function totalSavings(){
    return num("payrollSavings")+num("churnSavings")+num("workforceSavings")+num("deepDiveSavings")+num("leadershipSavings");
  }

  function deltaBadge(delta){
    if (!Number.isFinite(delta)) return "–";
    const cls = delta >= 0 ? "pos" : "neg";
    const sign = delta >= 0 ? "+" : "";
    return `<span class="${cls}">${sign}${fmt(delta)}</span>`;
  }

  function recalc(){
    const { gpNow, npNow } = computeNow();
    const fixes = totalSavings();
    const ors = num("orsRisk");
    const useFixes = document.getElementById("applyFixes")?.checked ?? false;
    const useORS = document.getElementById("applyORS")?.checked ?? false;

    // --- Table: Fixable Savings ---
    const gpNowCell = document.getElementById("gpNowCell");
    const npNowCell = document.getElementById("npNowCell");
    if (gpNowCell) gpNowCell.textContent = fmt(gpNow);
    if (npNowCell) npNowCell.textContent = fmt(npNow);

    const npFix = npNow + (useFixes ? fixes : 0);
    const gpFixCell = document.getElementById("gpFixCell");
    const npFixCell = document.getElementById("npFixCell");
    const npFixDelta = document.getElementById("npFixDelta");
    if (gpFixCell) gpFixCell.textContent = fmt(gpNow);
    if (npFixCell) npFixCell.textContent = fmt(npFix);
    if (npFixDelta) npFixDelta.innerHTML = deltaBadge(npFix - npNow);

    // --- Table: ORS Risk ---
    const gpNowORS = document.getElementById("gpNowORS");
    const npNowORS = document.getElementById("npNowORS");
    if (gpNowORS) gpNowORS.textContent = fmt(gpNow);
    if (npNowORS) npNowORS.textContent = fmt(npNow);

    const npORS = npNow + (useORS ? ors : 0);
    const gpORSCell = document.getElementById("gpORSCell");
    const npORSCell = document.getElementById("npORSCell");
    const npORSDelta = document.getElementById("npORSDelta");
    if (gpORSCell) gpORSCell.textContent = fmt(gpNow);
    if (npORSCell) npORSCell.textContent = fmt(npORS);
    if (npORSDelta) npORSDelta.innerHTML = deltaBadge(npORS - npNow);
  }

  function clearPage(){
    const ids = ["revenue","cogs","opex","grossNow","netNow","periodLabel",
      "payrollSavings","churnSavings","workforceSavings","deepDiveSavings","leadershipSavings","orsRisk",
      "applyFixes","applyORS"];
    for (const id of ids){
      localStorage.removeItem(id);
      const el = document.getElementById(id);
      if (!el) continue;
      if (el.type === "checkbox") el.checked = false;   // default OFF
      else el.value = "";
    }
    netNowTouched = false;
    recalc();
  }

  // ---------- INIT ----------
  function boot(){
    // 1) Try snapshot (if ORS page saved it)
    const snap = readSnapshotFromLocal();
    if (snap) applySnapshotToInputs(snap);

    // 2) Usual preload of saved values and cross-module keys
    const ids = ["revenue","cogs","opex","grossNow","netNow","periodLabel",
      "payrollSavings","churnSavings","workforceSavings","deepDiveSavings","leadershipSavings","orsRisk",
      "applyFixes","applyORS"];
    for (const id of ids){
      const el = document.getElementById(id);
      if (!el) continue;
      const stored = localStorage.getItem(id);
      if (stored != null){
        if (el.type === "checkbox") el.checked = stored === "true";
        else if (!el.value) el.value = stored;
      }
      el.addEventListener(el.type === "checkbox" ? "change" : "input", () => {
        localStorage.setItem(id, el.type === "checkbox" ? String(el.checked) : el.value);
      });
    }

    // mark when the user edits Net Profit manually
    document.getElementById("netNow")?.addEventListener("input", () => { netNowTouched = true; });

    // 3) Backfill from other module keys if still empty
    if (!num("payrollSavings")){ const v = lsFirstNumber(KEYMAP.savings.payroll); if (v!=null) setVal("payrollSavings", v); }
    if (!num("churnSavings")){ const v = lsFirstNumber(KEYMAP.savings.churn); if (v!=null) setVal("churnSavings", v); }
    if (!num("workforceSavings")){ const v = lsFirstNumber(KEYMAP.savings.workforce); if (v!=null) setVal("workforceSavings", v); }
    if (!num("deepDiveSavings")){ const v = lsFirstNumber(KEYMAP.savings.deep); if (v!=null) setVal("deepDiveSavings", v); }
    if (!num("leadershipSavings")){ const v = lsFirstNumber(KEYMAP.savings.leadership); if (v!=null) setVal("leadershipSavings", v); }
    if (!num("orsRisk")){ const v = lsFirstNumber(KEYMAP.ors); if (v!=null) setVal("orsRisk", v); }

    // listeners + first calc
    [
      "revenue","cogs","opex","netNow","payrollSavings","churnSavings",
      "workforceSavings","deepDiveSavings","leadershipSavings","orsRisk",
      "applyFixes","applyORS","periodLabel"
    ].forEach(id => {
      const el=document.getElementById(id);
      if (!el) return;
      el.addEventListener(el.type==="checkbox"?"change":"input", recalc);
    });

    // hook the two buttons
    document.getElementById("recalcFix")?.addEventListener("click", recalc);
    document.getElementById("recalcORS")?.addEventListener("click", recalc);

    recalc();
  }

  if (document.readyState === "loading") {
    window.addEventListener("DOMContentLoaded", boot);
  } else {
    boot();
  }
  </script>

  <!-- ===== Frontend send to API (Step 2) ===== -->
  <script>
  const SEND_URL = window.PROFIT_REPORT_ENDPOINT || "https://api.candooculture.com/send-profit-report";

  (function initReportEmail(){
    const el = document.getElementById("reportEmail");
    if (!el) return;
    const keys = ["candoo-user-email","reportEmail","userEmail","email"];
    for (const k of keys){
      const v = localStorage.getItem(k);
      if (v && !el.value) { el.value = v; break; }
    }
    el.addEventListener("input", ()=>{
      const v = el.value.trim();
      localStorage.setItem("reportEmail", v);
      localStorage.setItem("candoo-user-email", v);
    });
  })();

  function buildProfitReportPayload(){
    const numv = id => {
      const el = document.getElementById(id);
      if (!el) return 0;
      return Number(String(el.value||"").replace(/,/g,"").trim()) || 0;
    };
    const txt = id => document.getElementById(id)?.textContent || "–";

    return {
      period: document.getElementById("periodLabel")?.value || null,
      inputs: {
        revenue: numv("revenue"),
        cogs: numv("cogs"),
        opex: numv("opex"),
        grossNow: numv("grossNow") || null,
        netNow: numv("netNow")
      },
      savings: {
        payroll: numv("payrollSavings"),
        churn: numv("churnSavings"),
        workforce: numv("workforceSavings"),
        deepDive: numv("deepDiveSavings"),
        leadership: numv("leadershipSavings")
      },
      ors: {
        ebitdaAtRisk: numv("orsRisk")
      },
      scenarios: {
        applyFixes: !!document.getElementById("applyFixes")?.checked,
        applyORS: !!document.getElementById("applyORS")?.checked
      },
      results: {
        // Fixable Savings table
        now:   { gross: txt("gpNowCell"),  net: txt("npNowCell") },
        fixes: { gross: txt("gpFixCell"),  net: txt("npFixCell"),  delta: document.getElementById("npFixDelta")?.innerText || "–" },
        // ORS table
        nowORS:{ gross: txt("gpNowORS"),   net: txt("npNowORS") },
        orsOnly:{gross: txt("gpORSCell"),  net: txt("npORSCell"),  delta: document.getElementById("npORSDelta")?.innerText || "–" }
      }
    };
  }

  document.getElementById("sendReport")?.addEventListener("click", async ()=>{
    const emailEl = document.getElementById("reportEmail");
    const btn = document.getElementById("sendReport");
    if (!emailEl || !btn) return;

    const email = emailEl.value.trim();
    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
      alert("Please enter a valid email.");
      return;
    }

    const payload = buildProfitReportPayload();
    localStorage.setItem("candoo-user-email", email);

    btn.disabled = true;
    const prev = btn.textContent;
    btn.textContent = "Sending…";

    try{
      const res = await fetch(SEND_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "omit",
        body: JSON.stringify({ email, payload })
      });

      if (!res.ok){
        const t = await res.text().catch(()=> "");
        throw new Error(t || `HTTP ${res.status}`);
      }

      alert("Report sent. Check your inbox.");
    }catch(err){
      console.error(err);
      alert("Couldn’t send the report. We’ll wire the backend next or check CORS.");
    }finally{
      btn.disabled = false;
      btn.textContent = prev;
    }
  });
  </script>
</body>
</html>
